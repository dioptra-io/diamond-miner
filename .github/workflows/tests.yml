name: Tests

on: [push]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Create ClickHouse user config
        run: |
          mkdir -p ch-config/users.d
          cat > ch-config/users.d/default.xml <<'EOF'
          <clickhouse>
            <users>
              <default>
                <password></password>
                <networks><ip>::/0</ip></networks>
                <profile>default</profile>
                <quota>default</quota>
              </default>
            </users>
          </clickhouse>
          EOF

      - name: Create ClickHouse profile config
        run: |
          cat > ch-config/users.d/profiles.xml <<'EOF'
          <clickhouse>
            <profiles>
              <default>
                <allow_suspicious_ttl_expressions>1</allow_suspicious_ttl_expressions>
              </default>
            </profiles>
          </clickhouse>
          EOF
      - name: Show ClickHouse config files content
        run: |
          echo "Contents of users.d/default.xml:"
          cat ch-config/users.d/default.xml
          echo "Contents of users.d/profiles.xml:"
          cat ch-config/users.d/profiles.xml

      - name: Start ClickHouse
        run: |
          docker run -d --name clickhouse \
            -p 8123:8123 -p 9000:9000 \
            -v $PWD/ch-config/users.d:/etc/clickhouse-server/users.d:ro \
            clickhouse/clickhouse-server:25.7
          
      - name: Check container status
        run: docker ps -a
      
      - name: Wait for ClickHouse
        run: |
          for i in {1..120}; do
            if curl -s http://localhost:8123/ping; then exit 0; fi
            sleep 1
          done
          echo "ClickHouse did not start, dumping logs and container info:"
          docker logs clickhouse || echo "No logs"
          docker ps -a
          exit 1

      - uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - uses: dioptra-io/setup-poetry-action@v1
      - name: Install package
        run: poetry install

      - name: Insert test data
        run: poetry run python tests/data/insert.py
      - name: Run tests
        run: poetry run pytest --cov=diamond_miner --cov-report=xml
      - uses: codecov/codecov-action@v3

  mkdocs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - uses: dioptra-io/setup-poetry-action@v1
      - name: Install package
        run: poetry install
      - name: Build documentation
        run: poetry run mkdocs build --strict
      - name: Publish documentation
        run: poetry run mkdocs gh-deploy --force --no-history --strict
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}

  pypi:
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.x"
      - uses: dioptra-io/publish-python-action@v1
        with:
          password: ${{ secrets.PYPI_TOKEN }}
          upload: ${{ startsWith(github.ref, 'refs/tags/v') }}
